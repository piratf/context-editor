# 多环境支持技术方案

## 1. 概述

### 1.1 背景

Context Editor 是一个 VS Code 扩展，用于管理 Claude Code 项目和配置。用户可能在不同环境下工作：
- Windows 环境
- WSL (Windows Subsystem for Linux) 环境
- macOS 环境
- Linux 环境

特别是 Windows 用户，通常同时拥有一个或多个 WSL 环境，需要跨环境访问配置文件。

### 1.2 设计目标

1. **多环境并存** - 同时展示和管理多个环境的配置
2. **透明路径转换** - 上层组件无需关心环境差异
3. **单一职责** - 每层只负责一件事
4. **可扩展性** - 新增环境只需添加新的数据面实现
5. **可测试性** - 每层可独立测试

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                          渲染层 (Views)                              │
│  GlobalProvider | ProjectProvider | Commands                        │
├─────────────────────────────────────────────────────────────────────┤
│                    数据面层 (DataFacade)                             │
│  统一接口: getProjects() | getGlobalConfig(key) | getEnvironmentInfo() │
│  ┌───────────────────┐  ┌───────────────────┐  ┌──────────────────┐ │
│  │ NativeDataFacade  │  │ WindowsToWslDataFacade │  │ WslToWindowsDataFacade│ │
│  │ (同环境)          │  │ (Windows→WSL)     │  │ (WSL→Windows)    │ │
│  └───────────────────┘  └───────────────────┘  └──────────────────┘ │
├─────────────────────────────────────────────────────────────────────┤
│                    配置搜索层 (ConfigSearch)                         │
│  discoverAll() | refresh() | onDataFacadesChanged (Event)           │
├─────────────────────────────────────────────────────────────────────┤
│                       环境层 (Environment)                           │
│  - 单例 - 只读接口 - 轻量 - 只检测当前环境                          │
│  type: Windows | WSL | MacOS | Linux                                │
├─────────────────────────────────────────────────────────────────────┤
│                    路径转换层 (PathConverter)                        │
│  WslToWindowsPathConverter | WindowsToWslPathConverter              │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心概念

**数据面 (DataFacade)**：一个环境的数据抽象，提供统一接口访问该环境的 `.claude.json` 配置。数据面内部处理路径转换，对上层返回当前环境可直接使用的路径。

**多环境并存**：不再有"当前活动环境"的概念，而是同时持有多个数据面，每个环境一个。

---

## 3. 分层详细设计

### 3.1 环境层 (Environment)

**职责**：
- 检测当前 VS Code 运行在什么环境
- 提供只读接口供其他模块判断环境类型
- 单例模式，全局唯一

**核心接口**：
```typescript
interface Environment {
  // 只读属性
  readonly type: EnvironmentType;
  readonly homeDir: string;

  // 环境判断方法
  isWindows(): boolean;
  isWSL(): boolean;
  isMacOS(): boolean;
  isLinux(): boolean;

  // 平台无关的路径操作（供 NativeDataFacade 使用）
  getConfigPath(): string;       // 返回 .claude.json 的绝对路径
  joinPath(...segments: string[]): string;  // 路径拼接
}

enum EnvironmentType {
  Windows,
  WSL,
  MacOS,
  Linux
}
```

**实现要点**：
- 使用 `process.platform` 判断基础平台
- WSL 检测：检查 `/proc/version` 或 `wsl.exe` 命令
- 不检测其他环境，只确认当前环境
- 不提供环境切换功能

---

### 3.2 路径转换层 (PathConverter)

**职责**：
- 提供 Windows ↔ WSL 路径转换
- 处理新旧 WSL 路径格式

**核心接口**：
```typescript
interface PathConverter {
  convert(path: string): string;
}

class WslToWindowsPathConverter implements PathConverter {
  convert(wslPath: string): string;
}

class WindowsToWslPathConverter implements PathConverter {
  convert(windowsPath: string): string;
}
```

**WSL 路径格式处理**：
- 优先使用 `\\wsl.localhost\<实例名>\<路径>` (新格式)
- 降级使用 `\\wsl$\<实例名>\<路径>` (旧格式)
- 实例名从 WSL 配置中获取

---

### 3.3 数据面层 (DataFacade)

**职责**：
- 抽象 `.claude.json` 数据访问
- 提供统一接口，屏蔽环境差异
- 内部处理路径转换

**核心接口**：
```typescript
interface ClaudeDataFacade {
  // 环境信息
  getEnvironmentInfo(): EnvironmentInfo;

  // 项目列表（路径已转换为当前环境可用格式）
  getProjects(): Promise<ProjectEntry[]>;

  // 全局配置
  getGlobalConfig(key: string): Promise<any>;

  // 项目上下文文件（兼容当前实现）
  getProjectContextFiles(projectName: string): Promise<string[]>;
}

interface EnvironmentInfo {
  type: EnvironmentType;
  configPath: string;  // .claude.json 所在路径
  instanceName?: string; // WSL 实例名
}
```

**三种数据面实现**：

#### 3.3.1 NativeDataFacade（同环境数据面）

**场景**：访问当前环境的配置
**实现**：
- 通过 `Environment` 层获取平台无关的配置路径
- 直接读取本地 `.claude.json`
- 路径无需转换
- 支持所有平台（Windows、macOS、Linux）

**平台兼容性**：
- Windows: 通过 `environment.getConfigPath()` 获取 `C:\Users\<name>\.claude.json`
- macOS: 通过 `environment.getConfigPath()` 获取 `/Users/<name>/.claude.json`
- Linux: 通过 `environment.getConfigPath()` 获取 `/home/<name>/.claude.json`
- 路径拼接使用 `environment.joinPath()` 自动处理分隔符差异

#### 3.3.2 WindowsToWslDataFacade（Windows → WSL 数据面）

**场景**：Windows 环境访问 WSL 配置
**实现**：
- 使用 `\\wsl.localhost\` 或 `\\wsl$\` 路径访问 WSL 文件
- 读取 WSL 的 `.claude.json`
- 项目路径转换为 Windows 可访问格式
- **每个 WSL 实例对应一个独立的数据面对象**

#### 3.3.3 WslToWindowsDataFacade（WSL → Windows 数据面）

**场景**：WSL 环境访问 Windows 配置
**实现**：
- 使用 `/mnt/c/` 等路径访问 Windows 文件
- 读取 Windows 的 `.claude.json`
- 项目路径转换为 WSL 可访问格式

---

### 3.4 配置搜索层 (ConfigSearch)

**职责**：
- 发现所有可用环境
- 为每个有 `.claude.json` 的环境创建数据面
- 管理数据面列表

**核心接口**：
```typescript
interface ConfigSearch {
  // 发现所有环境并创建数据面
  discoverAll(): Promise<ClaudeDataFacade[]>;

  // 刷新数据面列表
  refresh(): Promise<ClaudeDataFacade[]>;

  // 数据面变化事件
  onDataFacadesChanged: Event<ClaudeDataFacade[]>;
}
```

**环境发现逻辑**：

**Windows 环境**：
1. 检查当前用户 `.claude.json` → 创建 NativeDataFacade
2. 先尝试访问 `\\wsl.localhost\` 获取 WSL 实例列表
3. 如果失败，降级到 `\\wsl$\` 获取实例列表
4. 对每个 WSL 实例：
   - 检查 `\\wsl.localhost\<实例>\home\<用户>\.claude.json`
   - 如果存在，创建 WslDataFacade

**WSL 环境**：
1. 检查当前用户 `.claude.json` → 创建 NativeDataFacade
2. 检查 `/mnt/c/Users/<用户>/.claude.json`
3. 如果存在，创建 WindowsDataFacade

**macOS/Linux 环境**：
1. 只检查当前用户 `.claude.json`
2. 创建 NativeDataFacade

---

### 3.5 渲染层 (Views)

**职责**：
- 从数据面获取数据并展示
- 响应数据面变化事件

**变化**：
- 不再依赖 `EnvironmentStateManager`
- 不再监听环境切换事件
- 直接调用数据面接口获取数据
- 监听 `onDataFacadesChanged` 事件刷新视图

---

## 4. 数据流

### 4.1 初始化流程

```
插件启动
    ↓
Environment 检测当前环境
    ↓
ConfigSearch.discoverAll()
    ↓
┌─────────────────────────────────────┐
│ 遍历所有可能的环境                   │
│ - 当前环境                          │
│ - WSL 实例（Windows）               │
│ - Windows（WSL）                    │
└─────────────────────────────────────┘
    ↓
对每个环境：
    1. 检查 .claude.json 是否存在
    2. 如果存在，创建对应的数据面
    3. 添加到数据面列表
    ↓
Views 订阅数据面列表
    ↓
展示所有环境的项目
```

### 4.2 数据访问流程

```
View.getTreeItem()
    ↓
调用 dataFacade.getProjects()
    ↓
数据面内部：
    1. 读取 .claude.json
    2. 解析项目列表
    3. 转换路径（如果需要）
    4. 返回当前环境可用的路径
    ↓
View 使用返回的路径创建 TreeItem
```

### 4.3 路径转换示例

**Windows 访问 WSL 项目**：
```
WSL .claude.json 中项目路径：/home/user/projects/myapp
    ↓
WindowsToWslDataFacade 内部转换
    ↓
返回 Windows 路径：\\wsl.localhost\Ubuntu\home\user\projects\myapp
    ↓
VSCode 可以直接打开
```

**WSL 访问 Windows 项目**：
```
Windows .claude.json 中项目路径：C:\Users\user\projects\myapp
    ↓
WslToWindowsDataFacade 内部转换
    ↓
返回 WSL 路径：/mnt/c/Users/user/projects/myapp
    ↓
VSCode 可以直接打开
```

---

## 5. 关键设计决策

### 5.1 WSL 检测方法

**决策**：路径轮询（`\\wsl.localhost\` → `\\wsl$\`）

**理由**：
- 命令检测（`wsl.exe -l -v`）需要额外进程开销
- 路径轮询直接验证可访问性
- 先尝试新格式，失败降级旧格式

### 5.2 路径转换时机

**决策**：数据面内部转换

**理由**：
- 上层组件无需关心环境差异
- 数据面接口返回的是"当前环境直接可用"的路径
- 职责清晰，数据面负责所有环境相关处理

### 5.3 缓存策略

**决策**：主动监听文件变化

**实现**：
- 使用 VS Code `FileSystemWatcher` 监听 `.claude.json`
- 跨环境监听由 VS Code API 自动处理
- 文件变化时触发 `onDataFacadesChanged` 事件

### 5.4 权限/错误处理

**决策**：静默跳过，Debug 日志

**实现**：
- 无法访问的环境（权限/停止状态）跳过
- 在 Debug 输出中记录
- 不影响其他环境的正常使用

---

## 6. 边界情况处理

### 6.1 WSL 实例状态

| 情况 | 处理 |
|:---|:---|
| 实例运行中 | 正常访问 |
| 实例已停止 | 跳过，Debug 日志 |
| 实例不存在 | 跳过，Debug 日志 |
| 无权限访问 | 跳过，Debug 日志 |

### 6.2 路径转换边界

| 情况 | 处理 |
|:---|:---|
| 路径包含特殊字符 | 正确转义 |
| 路径包含空格 | 正确处理 |
| 符号链接 | 跟随链接 |
| 路径不存在 | 返回原始路径，调用方处理 |

### 6.3 配置文件边界

| 情况 | 处理 |
|:---|:---|
| 文件不存在 | 不创建数据面 |
| JSON 格式错误 | 跳过该环境，记录错误 |
| 文件被占用 | 等待或跳过 |
| 文件正在写入 | 监听器触发重新读取 |

---

## 7. 与旧架构的差异

### 7.1 移除的概念

- **环境切换**：不再有"当前活动环境"概念
- **EnvironmentStateManager**：不再需要状态管理
- **onDidChangeEnvironment 事件**：不再有环境切换事件

### 7.2 新增的概念

- **数据面**：统一的数据访问抽象
- **多环境并存**：同时展示多个环境的配置
- **路径转换层**：独立的路径转换模块

### 7.3 核心区别

| 方面 | 旧架构 | 新架构 |
|:---|:---|:---|
| 环境管理 | 单一活动环境，需要切换 | 多数据面并存，无需切换 |
| 路径处理 | 运行时动态判断 | 数据面内部处理 |
| 配置访问 | 通过状态管理器 | 直接通过数据面接口 |
| 扩展性 | 新增环境需修改多处 | 新增数据面实现即可 |

---

## 8. 测试策略

### 8.1 单元测试

**环境层**：
- Windows 环境检测
- WSL 环境检测
- macOS/Linux 环境检测
- 单例模式验证

**路径转换层**：
- WSL → Windows 路径转换
- Windows → WSL 路径转换
- 新旧格式处理
- 特殊字符处理

**数据面**：
- NativeDataFacade 配置读取
- WindowsToWslDataFacade 配置读取和路径转换
- WslToWindowsDataFacade 配置读取和路径转换
- 错误处理

**配置搜索层**：
- 环境发现逻辑
- 数据面创建
- 空环境处理

### 8.2 集成测试

- Windows + 多 WSL 环境
- WSL + Windows 环境
- macOS/Linux 单环境
- 文件变化触发刷新
- 视图正确展示多环境数据

---

## 9. 迁移计划

### 9.1 阶段划分

**阶段 1：基础设施**
- 实现环境层
- 实现路径转换层
- 定义数据面接口

**阶段 2：数据面实现**
- NativeDataFacade
- WindowsToWslDataFacade
- WslToWindowsDataFacade

**阶段 3：搜索和集成**
- 配置搜索层
- 集成到 extension.ts

**阶段 4：视图重构**
- 重构 GlobalProvider
- 重构 ProjectProvider
- 移除环境切换相关代码

**阶段 5：测试和修复**
- 单元测试
- 集成测试
- Bug 修复

### 9.2 兼容性

- 保持现有的 `.claude.json` 格式不变
- 保持视图展示方式不变
- 用户无感知升级

---

## 10. 性能考虑

### 10.1 延迟加载

- 数据面按需创建
- 配置内容缓存
- 文件监听避免轮询

### 10.2 并发处理

- 环境发现并行执行
- 配置读取异步处理
- 避免阻塞主线程

---

## 11. 未来扩展

### 11.1 可能的扩展

- SSH 远程环境支持
- Docker 容器环境支持
- 自定义路径映射
- 配置文件编辑功能

### 11.2 扩展方式

新增环境只需：
1. 实现新的数据面类
2. 在配置搜索层添加发现逻辑
3. 复用现有接口和测试框架
